name: build-auto
on:
  push:
    tags:
      - 'v*'  # 只在推送标签时创建Release
    paths:
    - '.github/workflows/build-auto.yml'
    - 'build.sh'
    - 'laf'
  workflow_dispatch:  # 允许手动触发

jobs:
  build-auto:
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [windows-latest]
        build_type: [RelWithDebInfo]
        # 可以只构建Release版本，如果需要Debug可以取消注释
        # build_type: [RelWithDebInfo, Debug]
    
    steps:
    - uses: actions/checkout@v4
      with:
        submodules: 'recursive'
    
    - uses: aseprite/get-ninja@main
    
    - uses: ilammy/msvc-dev-cmd@v1
      if: runner.os == 'Windows'
    
    - name: Building
      shell: bash
      run: |
        bash build.sh --auto --norun
    
    - name: Running CLI Tests
      shell: bash
      run: |
        export ASEPRITE=$PWD/build/bin/aseprite
        cd tests
        bash run-tests.sh
    
    - name: Package artifacts
      shell: bash
      run: |
        # 获取版本号
        if [[ "${{ github.ref }}" == refs/tags/* ]]; then
          VERSION=${GITHUB_REF#refs/tags/}
        else
          VERSION=$(git rev-parse --short HEAD)
        fi
        
        # 创建发布目录
        mkdir -p release
        
        # 根据操作系统打包
        if [[ "${{ runner.os }}" == "Windows" ]]; then
          echo "Packaging Windows build..."
          
          # 检查构建产物位置
          if [ -d "build/bin" ] && [ -f "build/bin/aseprite.exe" ]; then
            # 复制可执行文件
            cp build/bin/aseprite.exe release/
            
            # 复制data目录
            if [ -d "build/data" ]; then
              cp -r build/data release/
            fi
            
            # 复制所有DLL文件
            find build -name "*.dll" -exec cp {} release/ \;
            
            # 创建ZIP包
            cd release
            7z a -tzip "../aseprite-windows-${VERSION}.zip" *
            cd ..
            
            echo "Package created: aseprite-windows-${VERSION}.zip"
          else
            echo "Error: Could not find aseprite.exe"
            exit 1
          fi
          
        elif [[ "${{ runner.os }}" == "Linux" ]]; then
          echo "Packaging Linux build..."
          # Linux打包逻辑
          if [ -f "build/bin/aseprite" ]; then
            tar -czf "aseprite-linux-${VERSION}.tar.gz" -C build/bin aseprite -C ../data . 2>/dev/null || true
          fi
          
        elif [[ "${{ runner.os }}" == "macOS" ]]; then
          echo "Packaging macOS build..."
          # macOS打包逻辑
          if [ -f "build/bin/aseprite" ]; then
            tar -czf "aseprite-macos-${VERSION}.tar.gz" -C build/bin aseprite -C ../data . 2>/dev/null || true
          fi
        fi
    
    - name: Upload artifacts (always)
      uses: actions/upload-artifact@v4
      with:
        name: aseprite-${{ runner.os }}-${{ matrix.build_type }}-${{ github.sha }}
        path: |
          *.zip
          *.tar.gz
        retention-days: 30
        if-no-files-found: warn
    
    - name: Create Release (only for tags)
      if: startsWith(github.ref, 'refs/tags/v') && runner.os == 'Windows'
      uses: softprops/action-gh-release@v1
      with:
        files: |
          aseprite-windows-*.zip
        name: Aseprite ${{ github.ref_name }}
        body: |
          ## Aseprite Windows 自动构建
            
          ### 版本信息
          - 版本: ${{ github.ref_name }}
          - 提交: ${{ github.sha }}
          - 构建类型: ${{ matrix.build_type }}
            
          ### 安装说明
          1. 下载 `aseprite-windows-${{ github.ref_name }}.zip`
          2. 解压到任意目录
          3. 运行 `aseprite.exe`
            
          ### 系统要求
          - Windows 10/11 64位
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
